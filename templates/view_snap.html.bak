{% extends "base.html" %}
{% block title %}View Snap{% endblock %}

{% block content %}
<div class="flex flex-col items-center justify-center min-h-screen bg-gray-900 text-white p-4">
  <!-- Main image viewer container -->
  <div class="relative bg-gray-800 rounded-lg shadow-xl" style="width: 90vw; height: 80vh;">
    <!-- Toolbar -->
    <div class="absolute top-0 left-0 right-0 z-10 bg-gray-800 bg-opacity-90 p-2 rounded-t-lg flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <span class="text-sm font-medium">Zoom: <span id="zoom-level">100%</span></span>
        <div class="h-4 border-l border-gray-600 mx-2"></div>
        <span class="text-sm" id="image-size"></span>
      </div>
      <div class="flex items-center space-x-2">
        <button id="reset-view" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Reset View</button>
      </div>
    </div>
    
    <!-- Image container with better overflow handling -->
    <div id="image-container" class="w-full h-full overflow-hidden relative">
      <div id="image-wrapper" class="absolute inset-0 flex items-center justify-center cursor-move">
        <img id="snap-img"
             src="{{ url_for('static', filename=snap.image_path) }}"
             alt="Snapshot"
             class="max-w-none max-h-none transition-transform duration-200"
             style="transform-origin: center center; will-change: transform;">
      </div>
    </div>
  </div>
  
  <!-- Control panel -->
  <div class="mt-4 p-4 bg-gray-800 rounded-lg shadow-lg w-full max-w-3xl">
    <div class="flex flex-wrap gap-4 justify-between items-center">
      <!-- Zoom controls -->
      <div class="flex items-center space-x-3">
        <button id="zoom-out" class="p-2 bg-blue-600 hover:bg-blue-700 rounded-full transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
          </svg>
        </button>
        <button id="zoom-in" class="p-2 bg-blue-600 hover:bg-blue-700 rounded-full transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
        </button>
      </div>

      <!-- Enhancement controls -->
      <div class="flex items-center space-x-3">
        <button id="enhance" class="flex items-center px-4 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg transition-colors">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          <span>Enhance Image</span>
        </button>
        <a href="{{ url_for('main.saved_snaps') }}" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
          Back to Gallery
        </a>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center backdrop-blur-sm">
    <div class="bg-gray-800 rounded-xl p-6 shadow-2xl flex flex-col items-center border border-gray-700">
      <div class="relative w-16 h-16">
        <div class="absolute inset-0 rounded-full border-4 border-blue-600 border-opacity-25"></div>
        <div class="absolute inset-0 rounded-full border-4 border-blue-600 border-t-transparent animate-spin"></div>
      </div>
      <p class="mt-4 text-lg font-medium">Enhancing Image...</p>
      <p class="mt-2 text-sm text-gray-400">This may take a few moments</p>
    </div>
  </div>

  <!-- Success/Error Toast -->
  <div id="toast" class="fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-xl transform transition-all duration-300 translate-y-full">
    <div class="flex items-center space-x-3">
      <svg id="toast-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
      <p id="toast-message" class="font-medium"></p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class ImageViewer {
  constructor() {
    this.container = document.getElementById('image-container');
    this.wrapper = document.getElementById('image-wrapper');
    this.img = document.getElementById('snap-img');
    this.zoomLevelEl = document.getElementById('zoom-level');
    this.imageSizeEl = document.getElementById('image-size');
    
    // State
    this.scale = 1;
    this.translateX = 0;
    this.translateY = 0;
    this.isDragging = false;
    this.lastX = 0;
    this.lastY = 0;
    
    // Bind methods
    this.updateTransform = this.updateTransform.bind(this);
    this.startDrag = this.startDrag.bind(this);
    this.onDrag = this.onDrag.bind(this);
    this.stopDrag = this.stopDrag.bind(this);
    this.onWheel = this.onWheel.bind(this);
    this.resetView = this.resetView.bind(this);
    
    // Initialize
    this.setupEventListeners();
    this.updateImageInfo();
    requestAnimationFrame(this.updateTransform);
  }
  
  setupEventListeners() {
    // Mouse controls
    this.wrapper.addEventListener('mousedown', this.startDrag);
    window.addEventListener('mousemove', this.onDrag);
    window.addEventListener('mouseup', this.stopDrag);
    
    // Touch controls
    this.wrapper.addEventListener('touchstart', (e) => {
      e.preventDefault();
      if (e.touches.length === 1) {
        this.startDrag(e.touches[0]);
      }
    });
    
    window.addEventListener('touchmove', (e) => {
      if (e.touches.length === 1) {
        e.preventDefault();
        this.onDrag(e.touches[0]);
      }
    });
    
    window.addEventListener('touchend', this.stopDrag);
    
    // Zoom controls
    this.container.addEventListener('wheel', this.onWheel, { passive: false });
    document.getElementById('zoom-in').addEventListener('click', () => this.zoom(0.1));
    document.getElementById('zoom-out').addEventListener('click', () => this.zoom(-0.1));
    document.getElementById('reset-view').addEventListener('click', this.resetView);
  }
  
  updateImageInfo() {
    this.img.onload = () => {
      this.imageSizeEl.textContent = `${this.img.naturalWidth}×${this.img.naturalHeight}px`;
    };
  }
  
  updateTransform() {
    const transform = `translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale})`;
    this.wrapper.style.transform = transform;
    this.zoomLevelEl.textContent = `${Math.round(this.scale * 100)}%`;
  }
  
  startDrag(e) {
    this.isDragging = true;
    this.lastX = e.clientX;
    this.lastY = e.clientY;
    this.wrapper.style.cursor = 'grabbing';
  }
  
  onDrag(e) {
    if (!this.isDragging) return;
    
    const dx = e.clientX - this.lastX;
    const dy = e.clientY - this.lastY;
    
    this.translateX += dx;
    this.translateY += dy;
    
    this.lastX = e.clientX;
    this.lastY = e.clientY;
    
    requestAnimationFrame(this.updateTransform);
  }
  
  stopDrag() {
    this.isDragging = false;
    this.wrapper.style.cursor = 'move';
  }
  
  zoom(delta, centerX = null, centerY = null) {
    const rect = this.container.getBoundingClientRect();
    const x = centerX ?? (rect.left + rect.width / 2);
    const y = centerY ?? (rect.top + rect.height / 2);
    
    const newScale = Math.max(0.1, Math.min(5, this.scale * (1 + delta)));
    
    if (newScale !== this.scale) {
      const scaleRatio = newScale / this.scale;
      const containerX = x - rect.left;
      const containerY = y - rect.top;
      
      this.translateX = containerX - (containerX - this.translateX) * scaleRatio;
      this.translateY = containerY - (containerY - this.translateY) * scaleRatio;
      this.scale = newScale;
      
      requestAnimationFrame(this.updateTransform);
    }
  }
  
  onWheel(e) {
    e.preventDefault();
    const delta = -Math.sign(e.deltaY) * 0.1;
    this.zoom(delta, e.clientX, e.clientY);
  }
  
  resetView() {
    this.scale = 1;
    this.translateX = 0;
    this.translateY = 0;
    requestAnimationFrame(this.updateTransform);
  }
}

class Toast {
  constructor() {
    this.toast = document.getElementById('toast');
    this.icon = document.getElementById('toast-icon');
    this.message = document.getElementById('toast-message');
    this.timeout = null;
  }
  
  show(type, text, duration = 3000) {
    // Clear any existing timeout
    if (this.timeout) {
      clearTimeout(this.timeout);
    }
    
    // Set icon and colors based on type
    if (type === 'success') {
      this.toast.className = 'fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-xl bg-green-600 text-white';
      this.icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>';
    } else {
      this.toast.className = 'fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-xl bg-red-600 text-white';
      this.icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>';
    }
    
    this.message.textContent = text;
    this.toast.style.transform = 'translateY(0)';
    
    // Auto hide after duration
    this.timeout = setTimeout(() => {
      this.toast.style.transform = 'translateY(150%)';
    }, duration);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const viewer = new ImageViewer();
  const toast = new Toast();
  // Set up enhancement handling
  const loadingOverlay = document.getElementById('loading-overlay');
  const enhanceBtn = document.getElementById('enhance');
  
  if (enhanceBtn) {
    enhanceBtn.addEventListener('click', async () => {
      try {
        loadingOverlay.style.display = 'flex';
        enhanceBtn.disabled = true;
        enhanceBtn.classList.add('opacity-50');
        
        const response = await fetch('/enhance_snap/{{ snap.id }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Create a new image element to preload the enhanced image
          const newImg = new Image();
          newImg.onload = () => {
            // Update the source and preserve the current view state
            viewer.img.src = data.enhanced_path;
            toast.show('success', 'Image enhanced successfully');
          };
          newImg.src = data.enhanced_path;
        } else {
          throw new Error(data.message || 'Enhancement failed');
        }
      } catch (error) {
        console.error('Enhancement error:', error);
        toast.show('error', error.message || 'Failed to enhance image');
      } finally {
        loadingOverlay.style.display = 'none';
        enhanceBtn.disabled = false;
        enhanceBtn.classList.remove('opacity-50');
      }
    });
  }
});
</script>
{% endblock %}
